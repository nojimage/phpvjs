# PHPvJS ミドルウェア プロジェクトガイドライン

## プロジェクト概要

PHPvJS ミドルウェアは、API を作成することなく PHP 変数を JavaScript フレームワークに渡すことを容易にする PHP ライブラリです。マルチページアプリケーション（MPA）アーキテクチャでウェブアプリケーションを迅速に開発する場合に特に役立ちます。

このプロジェクトは、PHP 変数を JavaScript に渡すことを可能にする PSR-15 準拠のミドルウェアを提供します。CakePHP、Slim、Laminas などの PSR-15 ミドルウェアスタックを持つフレームワークで使用するように設計されています。

### 必要要件

- PHP 8.2以上
- PSR-15対応のミドルウェアスタックを持つフレームワーク

### 主要コンポーネント

1. **VariableCarryInterface** - JavaScript に変数を渡すためのインターフェースを定義
   - `toJs()` - 変数を JavaScript に設定
   - `renderScriptTag()` - 変数を含むスクリプトタグをレンダリング
   - `reset()` - 変数をリセット
   - `getAttributeName()` - リクエスト属性名を取得

2. **VariableCarry** - 変数の保存とレンダリングのためのインターフェースを実装
   - `setJsData()` - 複数の変数を一度に設定
   - `setWindowVar()` - JavaScript のルート変数名をカスタマイズ（デフォルトは `__phpvjs__`）

3. **PHPvJSMiddleware** - 変数を HTML レスポンスに注入する PSR-15 ミドルウェア
   - HTML レスポンスの `<head>` タグ内にスクリプトを挿入
   - コンテンツタイプが HTML の場合のみ処理

## コードスタイルと標準

### PHP コーディング標準

このプロジェクトは [PSR-12](https://www.php-fig.org/psr/psr-12/) コーディング標準に従っています。すべてのコードはこの標準に準拠する必要があります。

主なポイント：
- インデントには4つのスペースを使用
- `declare(strict_types=1);` で厳格な型付けを使用
- 適切な名前空間を使用
- PSR-12 の命名規則に従う
- 適切な PHPDoc コメントを含める

### 静的解析

このプロジェクトは [PHPStan](https://phpstan.org/) を使用して静的解析を行い、以下の設定を使用しています：
- レベル 8（高い厳格さ）
- `src/` ディレクトリのみを解析
- 反復可能な値の型のチェックを行わない
- PHPDoc の型を確実なものとして扱わない

コード変更を提出する前に PHPStan を実行してください：
```bash
vendor/bin/phpstan analyse
```

### コード品質ツール

- **PHP_CodeSniffer**: PSR-12 コーディング標準を強制するために使用
  ```bash
  vendor/bin/phpcs
  ```

## 開発ワークフロー

### 開発環境のセットアップ

1. リポジトリをクローン
2. Composer で依存関係をインストール：
   ```bash
   composer install
   ```

### 変更の作成

1. 変更用の新しいブランチを作成
2. コーディング標準に従って変更を行う
3. 変更のテストを追加
4. テストを実行して合格することを確認
5. 静的解析とコードスタイルチェックを実行
6. プルリクエストを提出

## テストガイドライン

### テストフレームワーク

このプロジェクトは [PHPUnit](https://phpunit.de/) を使用してテストを行います。すべてのコードは徹底的にテストする必要があります。

### テスト構造

- テストは `tests/TestCase/` ディレクトリにあります
- 各クラスには対応するテストクラスが必要
- テストメソッドには説明的な名前を付ける
- 複数のシナリオをテストするためにデータプロバイダーを使用
- 通常の操作とエッジケースの両方をテスト

### テストの実行

```bash
vendor/bin/phpunit
```

### コードカバレッジ

このプロジェクトは高いコードカバレッジを目指しています。新機能の追加やバグ修正を行う際は、変更がテストでカバーされていることを確認してください。

## 貢献ガイドライン

### プルリクエストプロセス

1. コードがプロジェクトのコーディング標準に従っていることを確認
2. 必要に応じてドキュメントを更新
3. 変更のテストを追加
4. すべてのテストが合格することを確認
5. 変更の明確な説明を含むプルリクエストを提出

### 問題の報告

問題を報告する際は、以下を含めてください：
- 問題の明確な説明
- 問題を再現する手順
- 期待される動作
- 実際の動作
- 関連するログやエラーメッセージ

## ドキュメント標準

### コードドキュメント

- すべてのクラス、メソッド、プロパティには PHPDoc コメントが必要
- コメントは明確で説明的であること
- PHPDoc コメントに型情報を含める
- パラメータ、戻り値、例外を文書化する

### README とユーザードキュメント

- README ファイル（英語と日本語の両方）は最新の状態に保つ
- ドキュメントは明確で簡潔であること
- 一般的な使用例を含める
- 新バージョンでの破壊的変更を文書化する

## バージョニングとリリースプロセス

このプロジェクトは [セマンティックバージョニング](https://semver.org/) に従っています：
- MAJOR バージョンは互換性のない API 変更の場合
- MINOR バージョンは後方互換性のある機能追加の場合
- PATCH バージョンは後方互換性のあるバグ修正の場合

## 多言語サポート

このプロジェクトは英語と日本語の両方でドキュメントを提供しています。ドキュメントを更新する際は：
- README.md（英語）と README.ja.md（日本語）の両方を更新
- 翻訳が正確で一貫していることを確認
